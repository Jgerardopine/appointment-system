{
  "name": "Telegram Bot - Sistema de Citas MÃ©dicas",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message"
        ]
      },
      "id": "telegram-trigger",
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.1,
      "position": [
        240,
        500
      ],
      "webhookId": "telegram-bot-webhook",
      "credentials": {
        "telegramApi": {
          "id": "telegram_credentials",
          "name": "Telegram Bot API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse incoming Telegram message\nconst items = $input.all();\nconst results = [];\n\nfor (const item of items) {\n  const message = item.json.message;\n  \n  if (!message) {\n    continue;\n  }\n  \n  const text = message.text || '';\n  const chatId = message.chat?.id;\n  const userId = message.from?.id;\n  const username = message.from?.username;\n  const firstName = message.from?.first_name;\n  \n  // Parse command and parameters\n  let command = '';\n  let params = {};\n  \n  if (text.startsWith('/')) {\n    const parts = text.split(' ');\n    command = parts[0].substring(1);\n    \n    // Parse parameters based on command\n    if (command === 'agendar' && parts.length >= 4) {\n      params = {\n        doctor: parts.slice(1, -2).join(' '),\n        date: parts[parts.length - 2],\n        time: parts[parts.length - 1]\n      };\n    } else if (command === 'verificar' || command === 'cancelar' || command === 'confirmar') {\n      params = {\n        appointmentId: parts[1]\n      };\n    } else if (command === 'doctores') {\n      params = {\n        specialty: parts.slice(1).join(' ') || null\n      };\n    } else if (command === 'disponibilidad' && parts.length >= 3) {\n      params = {\n        doctorId: parts[1],\n        date: parts[2]\n      };\n    } else if (command === 'doctor_info') {\n      params = {\n        doctorId: parts[1]\n      };\n    }\n  } else {\n    command = 'natural';\n    params = { text: text };\n  }\n  \n  results.push({\n    json: {\n      command,\n      params,\n      chatId,\n      userId,\n      username,\n      firstName,\n      originalText: text,\n      timestamp: new Date().toISOString()\n    }\n  });\n}\n\nreturn results;"
      },
      "id": "parse-message",
      "name": "Parse Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        440,
        500
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": false
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.command }}",
                    "rightValue": "start",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "start"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.command }}",
                    "rightValue": "doctores",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "doctores"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.command }}",
                    "rightValue": "disponibilidad",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "disponibilidad"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.command }}",
                    "rightValue": "agendar",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "agendar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.command }}",
                    "rightValue": "verificar",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "verificar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.command }}",
                    "rightValue": "cancelar",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "cancelar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.command }}",
                    "rightValue": "confirmar",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "confirmar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.command }}",
                    "rightValue": "mis_citas",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "mis_citas"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.command }}",
                    "rightValue": "ayuda",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ayuda"
            }
          ]
        },
        "options": {}
      },
      "id": "command-router",
      "name": "Command Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        640,
        500
      ]
    },
    {
      "parameters": {
        "jsCode": "const firstName = $json.firstName || 'Usuario';\n\nconst message = `Â¡Hola ${firstName}! ğŸ‘‹\n\nBienvenido al Sistema de Citas MÃ©dicas ğŸ¥\n\nğŸ“‹ *Comandos disponibles:*\n\nğŸ©º */doctores [especialidad]* - Ver doctores disponibles\nğŸ“… */disponibilidad [doctor_id] [fecha]* - Ver horarios disponibles\nâœ… */agendar [doctor] [fecha] [hora]* - Agendar nueva cita\nğŸ” */verificar [id_cita]* - Ver detalles de una cita\nâœ… */confirmar [id_cita]* - Confirmar una cita pendiente\nâŒ */cancelar [id_cita]* - Cancelar una cita\nğŸ“‹ */mis_citas* - Ver todas tus citas\nâ“ */ayuda* - Ver esta ayuda\n\n*Ejemplos:*\n\\`/doctores CardiologÃ­a\\`\n\\`/disponibilidad 1 2024-11-25\\`\n\\`/agendar Dr. LÃ³pez 2024-11-25 10:00\\`\n\\`/confirmar 123\\``;\n\nreturn {\n  json: {\n    chatId: $json.chatId,\n    text: message,\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [\n          { text: 'ğŸ©º Ver Doctores', callback_data: '/doctores' },\n          { text: 'ğŸ“… Mis Citas', callback_data: '/mis_citas' }\n        ],\n        [\n          { text: 'â“ Ayuda', callback_data: '/ayuda' }\n        ]\n      ]\n    }\n  }\n};"
      },
      "id": "format-welcome",
      "name": "Format Welcome",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        840,
        300
      ]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "http://api-gateway:3000/api/appointments/doctors",
        "authentication": "none",
        "options": {}
      },
      "id": "get-doctors-api",
      "name": "Get Doctors API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        840,
        400
      ]
    },
    {
      "parameters": {
        "jsCode": "const doctors = $json.data || [];\nconst specialty = $('Command Router').item.json.params.specialty;\n\nlet message = '';\n\nif (doctors.length === 0) {\n  message = 'âŒ No se encontraron doctores disponibles.';\n} else {\n  if (specialty) {\n    message = `ğŸ©º *Doctores de ${specialty}:*\\n\\n`;\n  } else {\n    message = 'ğŸ©º *Doctores Disponibles:*\\n\\n';\n  }\n  \n  doctors.forEach(doctor => {\n    message += `ğŸ“‹ *${doctor.name}*\\n`;\n    message += `   ğŸ‘¨â€âš•ï¸ Especialidad: ${doctor.specialty}\\n`;\n    message += `   ğŸ“§ Email: ${doctor.email}\\n`;\n    message += `   ğŸ“ TelÃ©fono: ${doctor.phone}\\n`;\n    message += `   ğŸ• Horario: ${doctor.availability.schedule}\\n`;\n    message += `   ID: ${doctor.id}\\n\\n`;\n  });\n  \n  message += `\\nğŸ’¡ *Tip:* Usa */disponibilidad [doctor_id] [fecha]* para ver horarios\\nEjemplo: \\`/disponibilidad 1 2024-11-25\\``;\n}\n\nreturn {\n  json: {\n    chatId: $('Command Router').item.json.chatId,\n    text: message,\n    parse_mode: 'Markdown'\n  }\n};"
      },
      "id": "format-doctors-list",
      "name": "Format Doctors List",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1040,
        400
      ]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=http://api-gateway:3000/api/appointments/appointments/availability/{{ $json.params.doctorId }}?date={{ $json.params.date }}",
        "authentication": "none",
        "options": {}
      },
      "id": "get-availability-api",
      "name": "Get Availability API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        840,
        520
      ]
    },
    {
      "parameters": {
        "jsCode": "const availability = $json;\nconst doctorId = $('Command Router').item.json.params.doctorId;\nconst date = $('Command Router').item.json.params.date;\n\nlet message = `ğŸ“… *Disponibilidad para ${date}*\\n\\n`;\n\nif (availability.available_slots && availability.available_slots.length > 0) {\n  message += 'âœ… *Horarios Disponibles:*\\n';\n  availability.available_slots.forEach(slot => {\n    message += `   â€¢ ${slot}\\n`;\n  });\n  message += `\\nğŸ’¡ Para agendar usa:\\n\\`/agendar Doctor ${date} [hora]\\``;\n} else {\n  message += 'âŒ No hay horarios disponibles para esta fecha.\\n';\n  message += 'ğŸ’¡ Intenta con otra fecha.';\n}\n\nreturn {\n  json: {\n    chatId: $('Command Router').item.json.chatId,\n    text: message,\n    parse_mode: 'Markdown'\n  }\n};"
      },
      "id": "format-availability",
      "name": "Format Availability",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1040,
        520
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "={{ $json.text }}",
        "additionalFields": {
          "parse_mode": "={{ $json.parse_mode || 'Markdown' }}",
          "reply_markup": "={{ $json.reply_markup ? JSON.stringify($json.reply_markup) : '' }}"
        }
      },
      "id": "telegram-response",
      "name": "Telegram Response",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1240,
        500
      ],
      "credentials": {
        "telegramApi": {
          "id": "telegram_credentials",
          "name": "Telegram Bot API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const message = `â“ *Ayuda - Sistema de Citas MÃ©dicas*\n\nğŸ“‹ *Comandos Disponibles:*\n\nğŸ©º */doctores [especialidad]* \n   Ver lista de doctores disponibles\n   Ejemplo: \\`/doctores\\` o \\`/doctores CardiologÃ­a\\`\n\nğŸ“… */disponibilidad [doctor_id] [fecha]*\n   Ver horarios disponibles de un doctor\n   Ejemplo: \\`/disponibilidad 1 2024-11-25\\`\n\nâœ… */agendar [doctor] [fecha] [hora]*\n   Crear una nueva cita mÃ©dica\n   Ejemplo: \\`/agendar Dr. LÃ³pez 2024-11-25 10:00\\`\n\nâœ… */confirmar [id_cita]*\n   Confirmar una cita pendiente\n   Ejemplo: \\`/confirmar 123\\`\n\nğŸ” */verificar [id_cita]*\n   Ver detalles de una cita\n   Ejemplo: \\`/verificar 123\\`\n\nâŒ */cancelar [id_cita]*\n   Cancelar una cita existente\n   Ejemplo: \\`/cancelar 123\\`\n\nğŸ“‹ */mis_citas*\n   Ver todas tus citas programadas\n\nğŸ“… *Formato de Fechas:* YYYY-MM-DD\nğŸ• *Formato de Horas:* HH:MM\n\nğŸ’¡ *Tips:*\nâ€¢ Las fechas deben ser futuras\nâ€¢ Verifica disponibilidad antes de agendar\nâ€¢ Confirma tus citas pendientes`;\n\nreturn {\n  json: {\n    chatId: $json.chatId,\n    text: message,\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [\n          { text: 'ğŸ©º Ver Doctores', callback_data: '/doctores' }\n        ],\n        [\n          { text: 'ğŸ“… Mis Citas', callback_data: '/mis_citas' }\n        ],\n        [\n          { text: 'ğŸ  MenÃº Principal', callback_data: '/start' }\n        ]\n      ]\n    }\n  }\n};"
      },
      "id": "format-help",
      "name": "Format Help",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        840,
        640
      ]
    }
  ],
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Parse Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Message": {
      "main": [
        [
          {
            "node": "Command Router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Command Router": {
      "main": [
        [
          {
            "node": "Format Welcome",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Doctors API",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Availability API",
            "type": "main",
            "index": 0
          }
        ],
        [],
        [],
        [],
        [],
        [],
        [
          {
            "node": "Format Help",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Welcome": {
      "main": [
        [
          {
            "node": "Telegram Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Doctors API": {
      "main": [
        [
          {
            "node": "Format Doctors List",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Doctors List": {
      "main": [
        [
          {
            "node": "Telegram Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Availability API": {
      "main": [
        [
          {
            "node": "Format Availability",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Availability": {
      "main": [
        [
          {
            "node": "Telegram Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Help": {
      "main": [
        [
          {
            "node": "Telegram Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2024-11-25T00:00:00.000Z",
  "versionId": "1"
}